<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="You think you can, you can.">
<meta property="og:type" content="website">
<meta property="og:title" content="向山看海">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="向山看海">
<meta property="og:description" content="You think you can, you can.">
<meta property="og:locale">
<meta property="article:author" content="qiantu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>向山看海</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">向山看海</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-zjump">

    <a href="/zjump/" rel="section"><i class="fa fa-zjump fa-fw"></i>zjump</a>

  </li>
        <li class="menu-item menu-item-envmanage">

    <a href="/envmanage/" rel="section"><i class="fa fa-envmanage fa-fw"></i>envmanage</a>

  </li>
        <li class="menu-item menu-item-nginxadmin">

    <a href="/nginxadmin/" rel="section"><i class="fa fa-nginxadmin fa-fw"></i>nginxadmin</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-archives fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-zjump fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-about fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-books">

    <a href="/books/" rel="section"><i class="fa fa-books fa-fw"></i>books</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/15/iptable/%E7%94%A8iptables%E5%AE%9E%E7%8E%B0%E5%8D%95%E7%BD%91%E5%8D%A1%E5%81%9A%E7%BD%91%E5%85%B3%E4%B8%8A%E7%BD%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qiantu">
      <meta itemprop="description" content="You think you can, you can.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="向山看海">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/06/15/iptable/%E7%94%A8iptables%E5%AE%9E%E7%8E%B0%E5%8D%95%E7%BD%91%E5%8D%A1%E5%81%9A%E7%BD%91%E5%85%B3%E4%B8%8A%E7%BD%91/" class="post-title-link" itemprop="url">用iptables实现单网卡做网关上网</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-06-15 14:17:27" itemprop="dateCreated datePublished" datetime="2017-06-15T14:17:27+08:00">2017-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-05 10:19:43" itemprop="dateModified" datetime="2023-12-05T10:19:43+08:00">2023-12-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iptables/" itemprop="url" rel="index"><span itemprop="name">iptables</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->







<p>测试环境，配置iptables的服务器A的ip：172.16.81.156，默认网关172.16.80.1；网段192.168.1.0&#x2F;24通过交换机与A机连通；<br>A主机只有一块网卡eth0，主要的配置就是在单网卡上绑定一个虚拟ip，在通过iptables规则将192.168.1.0&#x2F;24段的源ip进行伪装，达到上网目的。<br>配置如下：<br>&#x2F;etc&#x2F;sysconfig&#x2F;ifcfg-eth0的配置信息：<br>DEVICE&#x3D;eth0<br>BOOTPROTO&#x3D;static<br>IPADDR&#x3D;172.16.81.156<br>NETMASK&#x3D;255.255.248.0<br>GATEWAY&#x3D;172.16.80.1<br>NETWORK&#x3D;172.16.80.0<br>ONBOOT&#x3D;yes<br>TYPE&#x3D;Ethernet</p>
<p>&#x2F;etc&#x2F;sysconfig&#x2F;ifcfg-eth0:1的配置信息：<br>DEVICE&#x3D;eth0:1<br>BOOTPROTO&#x3D;static<br>IPADDR&#x3D;192.168.1.1<br>NETMASK&#x3D;255.255.255.0<br>ONBOOT&#x3D;yes</p>
<p>echo 1 &gt; &#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;ip_forward(这句写到&#x2F;etc&#x2F;rc.d&#x2F;rc.local中)</p>
<p>iptables中的规则：<br>然后加入以下规则<br>iptables -F<br>iptables -F -t nat<br>iptables -A INPUT -i eth0 -j ACCEPT<br>iptables -A INPUT -i lo -j ACCEPT<br>iptables -t nat -A POSTROUTING -o eth0 -s 192.168.1.0&#x2F;24 -j MASQUERADE<br>iptables -A INPUT -i eth0 -m state –state ESTABLISHED,RELATED -j ACCEPT<br>service iptables save（自动生成&#x2F;etc&#x2F;sysconfig&#x2F;iptables）</p>
<p>客户端配置：<br>简单的说，就是在192.168.1.0&#x2F;24这个网段中的一个机器，指定以192.168.1.1为网关，再添加可用的DNC就可以了.<br>linux客户端的配置方法如下：<br>ifcfg-eth0：<br>DEVICE&#x3D;eth0<br>BOOTPROTO&#x3D;static<br>IPADDR&#x3D;192.168.1.2<br>NETMASK&#x3D;255.255.255.0<br>GATEWAY＝192.168.1.1<br>ONBOOT&#x3D;yes<br>设置DNS(&#x2F;etc&#x2F;resolv.con)<br>重启机器就可以上网了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/15/mysql/Percona%20XtraDB%20Cluster%20%E5%A4%9A%E4%B8%BB%E9%9B%86%E7%BE%A4%E7%A0%94%E7%A9%B6%E5%AE%9E%E7%8E%B0MYSQL%E8%B4%9F%E8%BD%BD%E5%88%86%E6%B5%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qiantu">
      <meta itemprop="description" content="You think you can, you can.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="向山看海">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/06/15/mysql/Percona%20XtraDB%20Cluster%20%E5%A4%9A%E4%B8%BB%E9%9B%86%E7%BE%A4%E7%A0%94%E7%A9%B6%E5%AE%9E%E7%8E%B0MYSQL%E8%B4%9F%E8%BD%BD%E5%88%86%E6%B5%81/" class="post-title-link" itemprop="url">mysql群集</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-06-15 14:17:27" itemprop="dateCreated datePublished" datetime="2017-06-15T14:17:27+08:00">2017-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-05 10:19:43" itemprop="dateModified" datetime="2023-12-05T10:19:43+08:00">2023-12-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->


<p>QXtraDB是MySQL开源的一个分支，在数据操作层面上，和MYSQL基本一样。其集群与常用的MYSQL集群特性如下：</p>
<p>个人认为XtraDB最大的优点，解决了传统集群的两个问题，<br>         一是，数据同步的及时性，解决了MYSQL做分步式方案时的时间差问题。<br>         二是实现了多主，各节点可同时读写，这样一来的话，在需要对大并发，大数据量的频繁操作处理的情况下，达到数据库层面负载分流的目的，且实现方便。同时有效的最大化利用了硬件资源。</p>
<p>局限性<br>1.目前的复制仅仅支持InnoDB存储引擎。任何写入其他引擎的表，包括mysql.*表将不会复制。但是DDL语句会被复制的，因此创建用户将会被复制，但是insert into mysql.user…将不会被复制的。</p>
<p>2.DELETE操作不支持没有主键的表。没有主键的表在不同的节点顺序将不同，如果执行SELECT…LIMIT… 将出现不同的结果集。</p>
<p>3.在多主环境下LOCK&#x2F;UNLOCK TABLES不支持。以及锁函数GET_LOCK(), RELEASE_LOCK()…</p>
<p>4.查询日志不能保存在表中。如果开启查询日志，只能保存到文件中。</p>
<p>5.允许最大的事务大小由wsrep_max_ws_rows和wsrep_max_ws_size定义。任何大型操作将被拒绝。如大型的LOAD DATA操作。</p>
<p>6.由于集群是乐观的并发控制，事务commit可能在该阶段中止。如果有两个事务向在集群中不同的节点向同一行写入并提交，失败的节点将中止。对于集群级别的中止，集群返回死锁错误代码(Error: 1213 SQLSTATE: 40001 (ER_LOCK_DEADLOCK)).</p>
<p>7.XA事务不支持，由于在提交上可能回滚。</p>
<p>8.整个集群的写入吞吐量是由最弱的节点限制，如果有一个节点变得缓慢，那么整个集群将是缓慢的。为了稳定的高性能要求，所有的节点应使用统一的硬件。</p>
<p>9.集群节点建议最少3个。</p>
<p>10.如果DDL语句有问题将破坏集群。</p>
<p>***********************      以下是配置步骤   *******************************<br>以下测试在 redhat6.4 64bit下实现【RPM方式安装】，采用三台机器，信息如下：<br>     db1  192.168.163.189<br>     db2  192.168.163.190<br>      db3  192.168.163.191<br>1、各节点配置和安装 2个 YUM 源<br>[EPEL]<br>name&#x3D;EPEL<br>baseurl&#x3D;<a href="http://mirror.neu.edu.cn/fedora/epel//6Server/x86_64/">http://mirror.neu.edu.cn/fedora/epel//6Server/x86_64/</a><br>enabled&#x3D;1<br>gpgcheck&#x3D;0<br>rpm -Uhv <a href="http://www.percona.com/downloads/percona-release/percona-release-0.0-1.x86_64.rpm">http://www.percona.com/downloads/percona-release/percona-release-0.0-1.x86_64.rpm</a></p>
<p>2、各节点删除系统自带的相关软件包<br>  rpm -e –nodeps  mysql-libs-5.1.66-2.el6_3.x86_64</p>
<p>3、各节点安装相关软件<br>yum install Percona-XtraDB-Cluster-server -y<br>正常情况下应该会安装以下相关软件包<br>     Percona-XtraDB-Cluster-server-55<br>     Percona-Server-shared-51<br>     Percona-XtraDB-Cluster-client-55<br>     Percona-XtraDB-Cluster-galera-2<br>     Percona-XtraDB-Cluster-shared-55<br>    percona-xtrabackup<br>    perl-DBD-MySQL</p>
<p>4、各节点my.cnf最基本的配置<br>[mysqld]<br>basedir&#x3D;&#x2F;usr #可修改<br>datadir&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql #可修改<br>wsrep_provider&#x3D;&#x2F;usr&#x2F;lib64&#x2F;libgalera_smm.so #需确认路径是否正常<br>wsrep_cluster_address&#x3D;gcomm:&#x2F;&#x2F;  #首次运行不指定，等整个集群启动后，再修改，否则集群无法启动<br>wsrep_slave_threads&#x3D;8<br>wsrep_sst_method&#x3D;rsync<br>binlog_format&#x3D;ROW<br>default_storage_engine&#x3D;InnoDB<br>innodb_locks_unsafe_for_binlog&#x3D;1<br>innodb_autoinc_lock_mode&#x3D;2<br>wsrep_sst_auth&#x3D;wsuser:redhat   #同步时使用的用户名及密码，格式为用户名：密码</p>
<p>5、集群中第一个节点192.168.163.189首次启动，启动时留意数据库错误日志信息<br>&#x2F;etc&#x2F;init.d&#x2F;mysql  bootstrap-pxc</p>
<p>6、第二个节点192.168.163.190首次启动<br>&#x2F;etc&#x2F;init.d&#x2F;mysql start wsrep_cluster_address&#x3D;gcomm:&#x2F;&#x2F;192.168.163.189,192.168.163.190</p>
<p>7 、第三个节点192.168.163.190首次启动<br>&#x2F;etc&#x2F;init.d&#x2F;mysql start wsrep_cluster_address&#x3D;gcomm:&#x2F;&#x2F;192.168.163.189,192.168.163.190,192.168.163.191</p>
<p>【注】以下各节点在启动前后，可用命令查看集群信息情况<br>mySQL&gt;show status like ‘wsrep%’;</p>
<p>8、各节点授权<br>授权：<br>MYSQL&gt;CREATE USER ‘wsuser‘@’localhost’ IDENTIFIED BY ‘redhat’;<br> GRANT RELOAD, LOCK TABLES, REPLICATION CLIENT ON <em>.</em> TO ‘wsuser‘@’localhost’;<br> FLUSH PRIVILEGES;</p>
<p>当所有节点启动后，修改各节点的MY.CNF修改参数wsrep_cluster_address&#x3D;gcomm:&#x2F;&#x2F;192.168.163.189,192.168.163.190,192.168.163.191</p>
<p>9、测试集群可用性<br>    1、在其中任意一个节点创建一个INNodb库，到其它节点检查是否已有库生成。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/15/mysql/mysql_%E4%B8%BB%E4%B8%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qiantu">
      <meta itemprop="description" content="You think you can, you can.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="向山看海">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/06/15/mysql/mysql_%E4%B8%BB%E4%B8%BB/" class="post-title-link" itemprop="url">mysql主主同步配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-06-15 14:17:27" itemprop="dateCreated datePublished" datetime="2017-06-15T14:17:27+08:00">2017-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-05 10:19:43" itemprop="dateModified" datetime="2023-12-05T10:19:43+08:00">2023-12-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->




<h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><pre><code>setenforce 0  
service iptables stop
yum -y install mysql-server mysql-devel mysql
service mysqld start
service mysqld stop
</code></pre>
<h4 id="192-168-128-140上操作"><a href="#192-168-128-140上操作" class="headerlink" title="192.168.128.140上操作"></a>192.168.128.140上操作</h4><pre><code>[root@localhost ~]# vim /etc/my.cnf 

[client]
default-character-set=utf8
[mysqld]
wait_timeout         = 864000
interactive_timeout  = 864000
datadir=/var/lib/mysql
socket=/var/lib/mysql/mysql.sock
user=mysql
# Disabling symbolic-links is recommended to prevent assorted security risks
symbolic-links=0

auto_increment_offset=1
auto-increment-increment=2
server_id = 140
log-bin=mysql-bin
character_set_server=utf8
replicate_wild_ignore_table=information_schema.%
replicate-wild_ignore_table=performance_schema.%
replicate-wild_ignore_table=test.%

[mysqld_safe]
log-error=/var/log/mysqld.log
pid-file=/var/run/mysqld/mysqld.pid

[root@localhost ~]# service mysqld restart
</code></pre>
<h4 id="192-168-128-137-上操作"><a href="#192-168-128-137-上操作" class="headerlink" title="192.168.128.137 上操作"></a>192.168.128.137 上操作</h4><p>[root@localhost ~]# vi &#x2F;etc&#x2F;my.cnf </p>
<pre><code>[client]
default-character-set=utf8
[mysqld]
wait_timeout         = 864000
interactive_timeout  = 864000
datadir=/var/lib/mysql
socket=/var/lib/mysql/mysql.sock
user=mysql
# Disabling symbolic-links is recommended to prevent assorted security risks
symbolic-links=0

auto_increment_offset=2
auto-increment-increment=2
server_id = 053
log-bin=mysql-bin
character_set_server=utf8
replicate_wild_ignore_table=information_schema.%
replicate-wild_ignore_table=performance_schema.%
replicate-wild_ignore_table=test.%

[mysqld_safe]
log-error=/var/log/mysqld.log
pid-file=/var/run/mysqld/mysqld.pid

[root@localhost ~]# service mysqld restart
</code></pre>
<h4 id="192-168-128-140-上操作"><a href="#192-168-128-140-上操作" class="headerlink" title="192.168.128.140 上操作"></a>192.168.128.140 上操作</h4><pre><code>mysql&gt; GRANT REPLICATION SLAVE ON *.* TO &#39;repl&#39;@&#39;192.168.128.137&#39; IDENTIFIED BY &#39;twlqccr&#39;;
mysql&gt; GRANT REPLICATION SLAVE ON *.* TO &#39;repl&#39;@&#39;192.168.128.140&#39; IDENTIFIED BY &#39;twlqccr&#39;;
mysql&gt; flush tables with read lock; 
mysql&gt; show master status\G
*************************** 1. row ***************************
            File: mysql-bin.000001
        Position: 430
    Binlog_Do_DB:
Binlog_Ignore_DB:
1 row in set (0.00 sec)

导出数据，scp到192.168.128..137
mysqldump qiantu &gt;/tmp/qiantu.sql 
scp /tmp/qiantu.sql 192.168.128.137:/tmp/

mysql&gt;UNLOCK TABLES;


192.168.128.137 上操作
mysql&gt; GRANT REPLICATION SLAVE ON *.* TO &#39;repl&#39;@&#39;192.168.128.137&#39; IDENTIFIED BY &#39;twlqccr&#39;;
mysql&gt; GRANT REPLICATION SLAVE ON *.* TO &#39;repl&#39;@&#39;192.168.128.140&#39; IDENTIFIED BY &#39;twlqccr&#39;;
mysql&gt; create database qiantu ;
mysql&gt; use qiantu;
mysql&gt; source /tmp/qiantu.sql;

stop slave;
reset slave;
change master to master_host=&#39;192.168.128.140&#39;,master_user=&#39;repl&#39;, master_password=&#39;twlqccr&#39;, master_port=3306, master_log_file=&#39;mysql-bin.000001&#39;, master_log_pos=430;
start slave;
show slave status\G
</code></pre>
<h4 id="在192-168-128-137看到两个yes就代表192-168-128-140-主-192-168-128-137-从-成功了"><a href="#在192-168-128-137看到两个yes就代表192-168-128-140-主-192-168-128-137-从-成功了" class="headerlink" title="在192.168.128.137看到两个yes就代表192.168.128.140(主)192.168.128.137(从)成功了"></a>在192.168.128.137看到两个yes就代表192.168.128.140(主)192.168.128.137(从)成功了</h4><p>反过来再做一次，就是主主了</p>
<h4 id="192-168-128-137-查看"><a href="#192-168-128-137-查看" class="headerlink" title="192.168.128.137 查看"></a>192.168.128.137 查看</h4><pre><code>mysql&gt; flush tables with read lock; 
mysql&gt; show master status\G
*************************** 1. row ***************************
            File: mysql-bin.000001
        Position: 1500
    Binlog_Do_DB:
Binlog_Ignore_DB:
1 row in set (0.00 sec)



192.168.128.140 上操作
stop slave;
reset slave;
change master to master_host=&#39;192.168.128.137&#39;,master_user=&#39;repl&#39;, master_password=&#39;twlqccr&#39;, master_port=3306, master_log_file=&#39;mysql-bin.000001&#39;, master_log_pos=1500;
start slave;
show slave status\G
</code></pre>
<h4 id="在192-168-128-140看到两个yes就代表主从192-168-128-137-主-192-168-128-140-从-成功了"><a href="#在192-168-128-140看到两个yes就代表主从192-168-128-137-主-192-168-128-140-从-成功了" class="headerlink" title="在192.168.128.140看到两个yes就代表主从192.168.128.137(主)192.168.128.140(从)成功了"></a>在192.168.128.140看到两个yes就代表主从192.168.128.137(主)192.168.128.140(从)成功了</h4><p>测试，新建一个数据库 去另一台机器看看是否有生成</p>
<h4 id="测试脚本"><a href="#测试脚本" class="headerlink" title="测试脚本"></a>测试脚本</h4><pre><code>#!/bin/bash
mysql -e &quot;create database qiantu;&quot;
mysql -e &quot;create table qiantu.demo(addtime timestamp);&quot;
while true
do
mysql -e &quot;select * from qiantu.demo;&quot;
sleep 3
mysql -e &quot;insert into qiantu.demo values(null);&quot;
done
</code></pre>
<p>#如果是克隆的第二台机器，要改下uuid，不然会报错<br>vim &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;auto.cnf<br>[auto]<br>server-uuid&#x3D;99424caf-4807-11e6-a88d-005056806ac1</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/15/mysql/mysql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qiantu">
      <meta itemprop="description" content="You think you can, you can.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="向山看海">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/06/15/mysql/mysql/" class="post-title-link" itemprop="url">DQL、DML、DDL、DCL的概念与区别</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-06-15 14:17:27" itemprop="dateCreated datePublished" datetime="2017-06-15T14:17:27+08:00">2017-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-05 10:19:43" itemprop="dateModified" datetime="2023-12-05T10:19:43+08:00">2023-12-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->



<h1 id="DQL、DML、DDL、DCL的概念与区别"><a href="#DQL、DML、DDL、DCL的概念与区别" class="headerlink" title="DQL、DML、DDL、DCL的概念与区别"></a>DQL、DML、DDL、DCL的概念与区别</h1><p>SQL(Structure Query Language)语言是数据库的核心语言。</p>
<p>SQL的发展是从1974年开始的，其发展过程如下：<br>1974年—–由Boyce和Chamberlin提出，当时称SEQUEL。<br>1976年—–IBM公司的Sanjase研究所在研制RDBMS SYSTEM R<br>时改为SQL。<br>1979年—–Oracle公司发表第一个基于SQL的商业化RDBMS产品。<br>1982年—–IBM公司出版第一个RDBMS语言SQL&#x2F;DS。<br>1985年—–IBM公司出版第一个RDBMS语言DB2。<br>1986年—–美国国家标准化组织ANSI宣布SQL作为数据库工业标准。<br>SQL是一个标准的数据库语言，是面向集合的描述性非过程化语言。<br>它功能强，效率高，简单易学易维护（迄今为止，我还没见过比它还好<br>学的语言）。然而SQL语言由于以上优点，同时也出现了这样一个问题：<br>它是非过程性语言，即大多数语句都是独立执行的，与上下文无关，而<br>绝大部分应用都是一个完整的过程，显然用SQL完全实现这些功能是很困<br>难的。所以大多数数据库公司为了解决此问题，作了如下两方面的工作：<br>(1)扩充SQL，在SQL中引入过程性结构；(2)把SQL嵌入到高级语言中，<br>以便一起完成一个完整的应用。</p>
<p>二. SQL语言的分类</p>
<p>SQL语言共分为四大类：数据查询语言DQL，数据操纵语言DML，数据定义语言DDL，数据控制语言DCL。</p>
<ol>
<li>数据查询语言DQL<br>数据查询语言DQL基本结构是由SELECT子句，FROM子句，WHERE<br>子句组成的查询块：<br>SELECT &lt;字段名表&gt;<br>FROM &lt;表或视图名&gt;<br>WHERE &lt;查询条件&gt;</li>
</ol>
<p>2 .数据操纵语言DML<br>数据操纵语言DML主要有三种形式：</p>
<ol>
<li>插入：INSERT</li>
<li>更新：UPDATE</li>
<li>删除：DELETE</li>
</ol>
<ol start="3">
<li>数据定义语言DDL<br>数据定义语言DDL用来创建数据库中的各种对象—–表、视图、<br>索引、同义词、聚簇等如：<br>CREATE TABLE&#x2F;VIEW&#x2F;INDEX&#x2F;SYN&#x2F;CLUSTER<br>| | | | |<br>表 视图 索引 同义词 簇</li>
</ol>
<p>DDL操作是隐性提交的！不能rollback</p>
<ol start="4">
<li>数据控制语言DCL<br>数据控制语言DCL用来授予或回收访问数据库的某种特权，并控制<br>数据库操纵事务发生的时间及效果，对数据库实行监视等。如：</li>
</ol>
<ol>
<li><p>GRANT：授权。</p>
</li>
<li><p>ROLLBACK [WORK] TO [SAVEPOINT]：回退到某一点。<br>回滚—ROLLBACK<br>回滚命令使数据库状态回到上次最后提交的状态。其格式为：<br>SQL&gt;ROLLBACK;</p>
</li>
<li><p>COMMIT [WORK]：提交。</p>
<p> 在数据库的插入、删除和修改操作时，只有当事务在提交到数据</p>
</li>
</ol>
<p>库时才算完成。在事务提交前，只有操作数据库的这个人才能有权看<br>到所做的事情，别人只有在最后提交完成后才可以看到。<br>提交数据有三种类型：显式提交、隐式提交及自动提交。下面分<br>别说明这三种类型。</p>
<p>(1) 显式提交<br>用COMMIT命令直接完成的提交为显式提交。其格式为：<br>SQL&gt;COMMIT；</p>
<p>(2) 隐式提交<br>用SQL命令间接完成的提交为隐式提交。这些命令是：<br>ALTER，AUDIT，COMMENT，CONNECT，CREATE，DISCONNECT，DROP，<br>EXIT，GRANT，NOAUDIT，QUIT，REVOKE，RENAME。</p>
<p>(3) 自动提交<br>若把AUTOCOMMIT设置为ON，则在插入、修改、删除语句执行后，<br>系统将自动进行提交，这就是自动提交。其格式为：<br>SQL&gt;SET AUTOCOMMIT ON；</p>
<h1 id="mysql上利用通配符模糊匹配数据库进行grant"><a href="#mysql上利用通配符模糊匹配数据库进行grant" class="headerlink" title="mysql上利用通配符模糊匹配数据库进行grant"></a>mysql上利用通配符模糊匹配数据库进行grant</h1><p> 给业务搭建数据库时由于采用的时分库策略，导致每个服务器上都有上百个数据库，新用户需要只对这些库有权限读写，由于服务器多，数据库多，如果采用逐个赋权限会很麻烦<br>在mysql中，当我们想对某个用户赋予权限时，对于数据库可以利用通配符（_和%）指定一类数据库进行操作，这样就可以避免逐个操作啦。<br>举例如下，假设我们有数据库，</p>
<pre><code>root@(none) 09:41:16&gt;show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| bp_crm             |
| dp_0007            |
| dp_0019            |
| dp_normandie_0028  |
| dp_p4p_0082        |
| dp_p4p_0169        |
| home               |
| mysql              |
| test               |
+--------------------+
10 rows in set (0.00 sec)
</code></pre>
<p>大家可以看到除了系统db（mysql,information_schema,test）之外，我们有一批报表库是以“dp”开头的，如果我们想创建一个用户，只对这些db可以进行操作，那么可以利用通配符%</p>
<pre><code>root@(none) 09:52:13&gt;select host,user,password     from mysql.user;
+------------------------+--------+-------------    ------------------------------+
| host                   | user   | password                                      |
+------------------------+--------+-------------    ------------------------------+
| localhost              | root   |                                               |
| linezing128042.sqa.cm4 | root   |                                               |
| 127.0.0.1              | root   |                                               |
| localhost              |        |                                               |
| linezing128042.sqa.cm4 |        |                                               |
| %                      | lzstat |     *23AE809DDACAF96AF0FD78ED04B6A265E05AA257 |
| %                      | admin  |     *4ACFE3202A5FF5CF467898FC58AAB1D615029441 |
| %                      | crm    |     *46E75F13B7337A95AAEB7680B6C52280D9CDF5D2 |
+------------------------+--------+-------------    ------------------------------+
8 rows in set (0.01 sec)

root@(none) 09:52:17&gt;grant all privileges on     `dp%`.* to dp_admin identified by &#39;mypasswd&#39;;
Query OK, 0 rows affected (0.00 sec)
</code></pre>
<p>注意这里不是单引号’，而是反单引号&#96;</p>
<pre><code>root@(none) 09:53:56&gt;flush privileges;
Query OK, 0 rows affected (0.01 sec)

root@(none) 09:54:38&gt;select host,user,password     from mysql.user;
+------------------------+----------+-----------    --------------------------------+
| host                   | user     | password                                      |
+------------------------+----------+-----------    --------------------------------+
| localhost              | root     |                                               |
| linezing128042.sqa.cm4 | root     |                                               |
| 127.0.0.1              | root     |                                               |
| localhost              |          |                                               |
| linezing128042.sqa.cm4 |          |                                               |
| %                      | lzstat   |     *23AE809DDACAF96AF0FD78ED04B6A265E05AA257 |
| %                      | admin    |     *4ACFE3202A5FF5CF467898FC58AAB1D615029441 |
| %                      | crm      |     *46E75F13B7337A95AAEB7680B6C52280D9CDF5D2 |
| %                      | dp_admin |     *85E26B8AB29FEE8453201A3511DAE24A24059109 |
+------------------------+----------+-----------    --------------------------------+
9 rows in set (0.00 sec)
</code></pre>
<p>我们测试一下远程登录，是否可以访问：</p>
<pre><code>[mysql@testdb2 ~]$ mysql -udp_admin     -h10.232.128.42 -pmypasswd

mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| dp_0007            |
| dp_0019            |
| dp_normandie_0028  |
| dp_p4p_0082        |
| dp_p4p_0169        |
| test               |
+--------------------+
7 rows in set (0.00 sec)
</code></pre>
<p>可以看到mysql db是无法看到的，这正符合我们的初衷。</p>
<pre><code>mysql&gt; use dp_0007
Reading table information for completion of     table and column names
You can turn off this feature to get a quicker     startup with -A

Database changed
mysql&gt; show tables;
+--------------------------------------+
| Tables_in_dp_0007                    |
+--------------------------------------+
| dpunit_p4p_campaign_d__201006        |
| dpunit_p4p_effect_contrast_d__201006 |
| dpunit_p4p_effect_contrast_d__201007 |
| mytest2                              |
| mytesttab                            |
+--------------------------------------+
5 rows in set (0.00 sec)

mysql&gt; select count(*) from     dpunit_p4p_campaign_d__201006;
+----------+
| count(*) |
+----------+
|    16622 |
+----------+
1 row in set (0.00 sec)

mysql&gt; use dp_p4p_0082
Reading table information for completion of     table and column names
You can turn off this feature to get a quicker     startup with -A

Database changed
mysql&gt; show tables;
+---------------------------------------------+
| Tables_in_dp_p4p_0082                       |
+---------------------------------------------+
| dim_m_star                                  |
。。。。。
| dpunit_p4p_platform_d__201006               |
| dpunit_p4p_platform_d__201007               |
| dpunit_p4p_platform_d__201008               |
| lz_dim_category_level1                      |
| mytest2                                     |
| mytesttab                                   |
+---------------------------------------------+
74 rows in set (0.00 sec)

mysql&gt; select count(*) from     dpunit_p4p_platform_d__201008;
+----------+
| count(*) |
+----------+
|    38640 |
+----------+
1 row in set (0.00 sec)
</code></pre>
<p>看到可以访问操作“dp”开头的数据库。</p>
<p>注意：_也是通配符，在你grant “dp_p4p”开头的数据库权限时需要用”&quot;做一下转义。</p>
<pre><code>root@(none) 10:18:15&gt;grant all privileges on     `dp\_p4p%`.* to dp_admin2 identified by     &#39;mypasswd&#39;;
Query OK, 0 rows affected (0.00 sec)

root@(none) 10:22:41&gt;flush privileges;
Query OK, 0 rows affected (0.01 sec)

root@(none) 10:22:46&gt;select host,user,password     from mysql.user;
+------------------------+-----------+----------    ---------------------------------+
| host                   | user      | password                                      |
+------------------------+-----------+----------    ---------------------------------+
| localhost              | root      |                                               |
| linezing128042.sqa.cm4 | root      |                                               |
| 127.0.0.1              | root      |                                               |
| localhost              |           |                                               |
| linezing128042.sqa.cm4 |           |                                               |
| %                      | lzstat    |     *23AE809DDACAF96AF0FD78ED04B6A265E05AA257 |
| %                      | admin     |     *4ACFE3202A5FF5CF467898FC58AAB1D615029441 |
| %                      | crm       |     *46E75F13B7337A95AAEB7680B6C52280D9CDF5D2 |
| %                      | dp_admin  |     *85E26B8AB29FEE8453201A3511DAE24A24059109 |
| %                      | dp_admin2 |     *85E26B8AB29FEE8453201A3511DAE24A24059109 |
+------------------------+-----------+----------    ---------------------------------+
10 rows in set (0.00 sec)
</code></pre>
<p>我们测试一下远程登录，是否可以访问：</p>
<pre><code>[mysql@testdb2 ~]$ mysql -udp_admin2     -h10.232.128.42 -pmypasswd

mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| dp_p4p_0082        |
| dp_p4p_0169        |
| test               |
+--------------------+
4 rows in set (0.00 sec)
</code></pre>
<p>注意，dp_admin2只有权限看到”dp_p4p”开头的数据库，dp_p4p_0082和dp_p4p_0169</p>
<p>同样你也可以在hostname中指定通配符，但不可以在user中指定：</p>
<pre><code>root@(none) 10:36:53&gt;grant all privileges on     `dp\_p4p%`.* to dp_admin3@&#39;10.254.3.%&#39;     identified by &#39;mypasswd&#39;;
Query OK, 0 rows affected (0.00 sec)

root@(none) 10:37:25&gt;flush privileges;
</code></pre>
<p>表示10.254.3子网段的服务器都可以访问”dp_p4p”这类数据库，注意这里是单引号</p>
<p>另外，使用反勾号(&#96;)为数据库、表、列和子程序名称加引号。使用单引号(‘)为hostnames、usernames和password加引号。</p>
<pre><code>root@(none) 10:58:26&gt;grant select on     dp_p4p_0082.`dpunit_p4p_effect_adgroup_bidword_d    __201006` to dp_admin4@&#39;10.254.3.%&#39; identified     by &#39;mypasswd&#39;;
Query OK, 0 rows affected (0.00 sec)

root@(none) 10:58:22&gt;flush privileges;
Query OK, 0 rows affected (0.00 sec)
</code></pre>
<p>例子中，表用的是反引号&#96;，而给hostname和密码用的是单引号’    </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/15/zabbix/zabbix3.2.1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qiantu">
      <meta itemprop="description" content="You think you can, you can.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="向山看海">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/06/15/zabbix/zabbix3.2.1/" class="post-title-link" itemprop="url">zabbix3.2.1分布式监控，采用agent主动模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-06-15 14:17:27" itemprop="dateCreated datePublished" datetime="2017-06-15T14:17:27+08:00">2017-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-05 10:19:43" itemprop="dateModified" datetime="2023-12-05T10:19:43+08:00">2023-12-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/zabbix/" itemprop="url" rel="index"><span itemprop="name">zabbix</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->



<h1 id="zabbix3-2-1分布式监控，采用agent主动模式"><a href="#zabbix3-2-1分布式监控，采用agent主动模式" class="headerlink" title="zabbix3.2.1分布式监控，采用agent主动模式"></a>zabbix3.2.1分布式监控，采用agent主动模式</h1><p>有点：1、分布式，全部agent先提交到各个机房的zabbix_proxy，再有zabbix_proxy提交到到server，减少					zabbix_server压力</p>
<p>服务端 安装参考  Zabbix 3.2.0 yum或编译安装 on CentOS 7.note<br>配置制动注册让agent自动注册，免去一个个手动添加</p>
<p>proxy 安装参考 zabbix分布式监控proxy部署.note</p>
<p>cd &#x2F;root&#x2F;zabbix-3.2.1<br>.&#x2F;configure –prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;zabbix_agent –enable-agent<br> make install<br>修改 vim &#x2F;usr&#x2F;local&#x2F;zabbix_agent&#x2F;etc&#x2F;zabbix_agentd.conf<br>#Server 写proxy的ip<br>Server&#x3D;172.16.1.198 </p>
<p>useradd zabbix<br>&#x2F;usr&#x2F;local&#x2F;zabbix_agent&#x2F;sbin&#x2F;zabbix_agentd -c &#x2F;usr&#x2F;local&#x2F;zabbix_agent&#x2F;etc&#x2F;zabbix_agentd.conf</p>
<p>错误1 没发现host，如果是被动模式的话就是就是server上没配对应的host，但是我用的是主动模式，不需要手动添加，只要添加自动加host的action就行，我遇到的问题是这个action没启动，我记得是启用了得。不知道什么时候被禁用了！！！<br>[图片]<br>解决方法：<br>[图片]</p>
<p>测试方法：<br>[root@xs_proxy ~]# &#x2F;usr&#x2F;local&#x2F;zabbix&#x2F;bin&#x2F;zabbix_get -s 172.17.2.201 -p20050 -k”system.uptime”<br>16936953</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/15/zabbix/%E8%87%AA%E5%8A%A8%E5%B7%A1%E6%A3%80%E8%84%9A%E6%9C%AC(%E8%B0%83%E7%94%A8zabbix%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0)%20-%20%E5%89%AF%E6%9C%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qiantu">
      <meta itemprop="description" content="You think you can, you can.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="向山看海">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/06/15/zabbix/%E8%87%AA%E5%8A%A8%E5%B7%A1%E6%A3%80%E8%84%9A%E6%9C%AC(%E8%B0%83%E7%94%A8zabbix%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0)%20-%20%E5%89%AF%E6%9C%AC/" class="post-title-link" itemprop="url">自动巡检脚本(调用zabbix接口实现)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-06-15 14:17:27" itemprop="dateCreated datePublished" datetime="2017-06-15T14:17:27+08:00">2017-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-05 10:19:43" itemprop="dateModified" datetime="2023-12-05T10:19:43+08:00">2023-12-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/zabbix/" itemprop="url" rel="index"><span itemprop="name">zabbix</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->



<pre><code>crontab: no changes made to crontab
[root@autoyunwei ~]# vim /etc/crontab 
[root@autoyunwei ~]# vim /root/script/xunjian.py
[root@autoyunwei ~]# cat  /root/script/xunjian.py
#!/usr/bin/env python
# -*- coding:utf-8 -*- 
#Author: qiantu
#qq 261767353

import os
import time
import shutil
import MySQLdb
import smtplib
import requests
import datetime

from email.MIMEText import MIMEText
from email.MIMEImage import MIMEImage
from email.MIMEMultipart import MIMEMultipart

# based on zabbix 2.4.4
ZABBIX_HOST = &#39;192.168.2.91&#39;
ZABBIX_USER = &#39;Admin&#39;
ZABBIX_PWD = &#39;zzjr#2015&#39;

ZABBIX_DB_HOST = &#39;192.168.2.91&#39;
ZABBIX_DB_USER = &#39;zabbix&#39;
ZABBIX_DB_PWD = &#39;zabbix&#39;
ZABBIX_DB_NAME = &#39;zabbix&#39;

GRAPH_PATH = &quot;zabbix_img&quot;
GRAPH_PERIOD = 86400  # one day

EMAIL_DOMAIN = &#39;zuozh.com&#39;
EMAIL_USERNAME = &#39;wangqiantu&#39;
EMAIL_PASSWORD = &#39;Lht1111&#39;


def query_screens(screen_name):
    conn = MySQLdb.connect(host=ZABBIX_DB_HOST, user=ZABBIX_DB_USER, passwd=ZABBIX_DB_PWD,
                        db=ZABBIX_DB_NAME, charset=&#39;utf8&#39;, connect_timeout=20)
    cur = conn.cursor()
    count = cur.execute(&quot;&quot;&quot;
            select a.name, a.screenid, b.resourceid, b.width, b.height
                from screens a, screens_items as b
                where a.screenid=b.screenid and a.templateid&lt;=&gt;NULL and a.name=&#39;%s&#39;
                order by a.screenid;
            &quot;&quot;&quot; % screen_name)
    if count == 0:
        result = 0
    else:
        result = cur.fetchall()

    cur.close()
    conn.close()

    return result


def generate_graphs(screens):
    login_resp = requests.post(&#39;http://%s/zabbix/index.php&#39; % ZABBIX_HOST, data=&#123;
        &#39;name&#39;: ZABBIX_USER,
        &#39;password&#39;: ZABBIX_PWD,
        &#39;enter&#39;: &#39;Sign in&#39;,
        &#39;autologin&#39;: 1,
    &#125;)
    session_id = login_resp.cookies[&#39;zbx_sessionid&#39;]

    graphs = []
    for i, (screen_name, screen_id, graph_id, width, height) in enumerate(screens):
        params = &#123;
            &#39;screenid&#39;: screen_id,
            &#39;graphid&#39;: graph_id,
            &#39;width&#39;: width * 2,
            &#39;height&#39;: height * 2,
            &#39;period&#39;: GRAPH_PERIOD,
            &#39;stime&#39;: datetime.datetime.utcnow().strftime(&#39;%Y%m%d%H%M%S&#39;),
        &#125;
        resp = requests.get(&#39;http://%s/zabbix/chart2.php&#39; % ZABBIX_HOST, params=params,
                            cookies=&#123;&#39;zbx_sessionid&#39;: session_id&#125;)
        file_name = &#39;_&#39;.join(map(str, screens[i][:3])).replace(&#39; &#39;, &#39;_&#39;) + &#39;.png&#39;
        with open(os.path.join(GRAPH_PATH, file_name), &#39;wb&#39;) as fp:
            fp.write(resp.content)
        graphs.append(file_name)

    return graphs


def send_mail(screen_name, graphs, to_list):
    me = u&#39;巡检报告 &lt;%s@%s&gt;&#39; % (EMAIL_USERNAME, EMAIL_DOMAIN)

    def _create_msg():
        msg = MIMEMultipart(&#39;related&#39;)
        title=u&quot;每日巡检报告&quot;
        msg[&#39;Subject&#39;] = &#39;%s: %s&#39; % (title,screen_name)
        msg[&#39;From&#39;] = me
        msg[&#39;To&#39;] = &#39;;&#39;.join(to_list)
        msg.preamble = &#39;This is a multi-part message in MIME format.&#39;

        contents = &quot;&lt;h1&gt;Screen %s&lt;/h1&gt;&lt;br&gt;&quot; % screen_name
        contents += &quot;&lt;table&gt;&quot;
        for g_name in graphs:
            with open(os.path.join(GRAPH_PATH, g_name), &#39;rb&#39;) as fp:
                msg_image = MIMEImage(fp.read())
                msg_image.add_header(&#39;Content-ID&#39;, &quot;&lt;%s&gt;&quot; % g_name)
                msg.attach(msg_image)

            contents += &#39;&#39;
            contents += &quot;&lt;tr&gt;&lt;td&gt;&lt;img src=&#39;cid:%s&#39;&gt;&lt;/td&gt;&lt;/tr&gt;&quot; % g_name
        contents += &quot;&lt;/table&gt;&quot;

        msg_text = MIMEText(contents, &#39;html&#39;)
        msg_alternative = MIMEMultipart(&#39;alternative&#39;)
        msg_alternative.attach(msg_text)
        msg.attach(msg_alternative)

        return msg

    try:
        server = smtplib.SMTP()
        server.connect(&#39;smtp.%s&#39; % EMAIL_DOMAIN)
        server.login(&#39;%s@%s&#39; % (EMAIL_USERNAME, EMAIL_DOMAIN), EMAIL_PASSWORD)
        server.sendmail(me, to_list, _create_msg().as_string())
        server.close()
        print &#39;send mail Ok!&#39;
    except Exception, e:
        print e


if __name__ == &#39;__main__&#39;:
    # remove old dirs
    if os.path.exists(GRAPH_PATH):
        shutil.rmtree(GRAPH_PATH)
    os.makedirs(GRAPH_PATH)

    for srn_name in (u&#39;All databases machine cpu&#39;,u&#39;All virtual machine io&#39;,u&#39;All virtual machine memory&#39;,u&#39;All virtual machine traffic&#39;,u&#39;ALL nginx connections&#39;):
        # get screens
        all_screens = query_screens(srn_name)
        print all_screens

        # generate graphs
        graphs = generate_graphs(all_screens)

        send_mail(srn_name, graphs, [&#39;monitor@zuozh.com&#39;])
        #send_mail(srn_name, graphs, [&#39;wangqiantu@zuozh.com&#39;])
</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/15/python/Django%E4%B8%AD%E5%86%85%E7%BD%AE%E7%9A%84%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B61%EF%BC%8DUser%20Model/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qiantu">
      <meta itemprop="description" content="You think you can, you can.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="向山看海">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/06/15/python/Django%E4%B8%AD%E5%86%85%E7%BD%AE%E7%9A%84%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B61%EF%BC%8DUser%20Model/" class="post-title-link" itemprop="url">Django中内置的权限控制1－User Model</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-06-15 14:17:27" itemprop="dateCreated datePublished" datetime="2017-06-15T14:17:27+08:00">2017-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-05 10:19:43" itemprop="dateModified" datetime="2023-12-05T10:19:43+08:00">2023-12-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/django/" itemprop="url" rel="index"><span itemprop="name">django</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->


<h2 id="Django中内置的权限控制1－User-Model"><a href="#Django中内置的权限控制1－User-Model" class="headerlink" title="Django中内置的权限控制1－User Model"></a>Django中内置的权限控制1－User Model</h2><p>在Django的世界中，在权限管理中有内置的Authentication系统。用来管理帐户，组，和许可。还有基于cookie的用户session。这篇blog主要用来探讨这套内置的Authentication系统。</p>
<p>Django内置的权限系统包括以下三个部分：  </p>
<pre><code>用户（Users）
许可（Permissions）：用来定义一个用户（user）是否能够做某项任务（task）
组（Groups）：一种可以批量分配许可到多个用户的通用方式
</code></pre>
<p>首先需要在Django中安装这个组件：</p>
<pre><code>将&#39;django.contrib.auth&#39;和&#39;django.contrib.contenttypes&#39;放到settings.py中的INSTALLED_APPS中。（使用contenttypes的原因是auth中的Permission模型依赖于contenttypes）
执行manage.py syncdb
</code></pre>
<p>装好了就可以开始使用了；我们可以执行manage.py shell来启动脚本，对其中的一些API进行学习和使用。</p>
<p>首先最重要的开始就是User模型<br>User模型对应于一个用户，一个帐户，位于’django.contrib.auth.models’模块中。</p>
<p>User对象有两个多对多的属性分别是：groups和user_permissions：</p>
<pre><code>&gt;&gt;&gt;from django.contrib.auth.models import User
&gt;&gt;&gt;es = User.objects.create_user(&#39;esperyong&#39;,&#39;esperyong@gmail.com&#39;,&#39;123456&#39;)
&gt;&gt;&gt;es.groups
&lt;django.db.models.fields.related.ManyRelatedManager at 0x10d0642d0&gt;
&gt;&gt;&gt;es.user_permissions
&lt;django.db.models.fields.related.ManyRelatedManager at 0x10d014c50&gt;
</code></pre>
<p>从上面的代码中的后两行输出我们可以看到，User的这两个多对多属性，都是关于ManyRelatedManager的引用。因此我们可以像对所有对多关系属性一样使用：</p>
<p>直接将一个列表赋值给该属性：</p>
<pre><code>es.groups = [group_list]
es.user_permissions = [permission_list]
</code></pre>
<p>使用add方法将对象加入：</p>
<pre><code>es.groups.add(group, group, ...)
es.user_permissions.add(permission, permission, ...)
</code></pre>
<p>使用remove方法将对象删除：</p>
<pre><code>es.groups.remove(group, group, ...)
es.user_permissions.remove(permission, permission, ...)
</code></pre>
<p>使用clear方法将所有对象删除：</p>
<pre><code>es.groups.clear()
es.user_permissions.clear()
</code></pre>
<p>　　</p>
<p>User对象有以下几个属性：</p>
<pre><code>username:字符串类型。必填。30个字符以内。
first_name:字符串类型。可选。30个字符以内。
last_name:字符串类型。可选。30个字符以内。
email:可选。
password:明文密码的hash或者是某种元数据。该属性不应该直接赋值明文密码，而应该    通过set_password()方法进行赋值，在后面有详细说明TODO。
is_staff:Boolean类型。用这个来判断是否用户可以登录进入admin site。
is_active:Boolean类型。用来判断该用户是否是可用激活状态。在删除一个帐户的时候    ，可以选择将这个属性置为False，而不是真正删除。这样如果应用有外键引用到这个用    户，外键就不会被破坏。
is_superuser:Boolean类型。该属性用来表示该用户拥有所有的许可，而无需明确的赋    予给他。
last_login:datetime类型。最近一次登陆时间。
date_joined：datetime类型。创建时间。
</code></pre>
<p>除了DjangoModel对象的通用方法之外，User对象有以下特有方法：</p>
<pre><code>is_anonymous():
永远返回False.用来将User对象和AnonymousUser(未登录的匿名用户)对象作区分用的识    别方法。通常，最好用is_authenticated()方法。
is_authenticated():
永远返回True。该方法不代表该用户有任何的许可，也不代表该用户是active的，而只    是表明该用户提供了正确的username和password。
get_full_name():
返回一个字符串，是first_name和last_name中间加一个空格组成。
set_password(raw_password):
调用该方法时候传入一个明文密码，该方法会进行hash转换。该方法调用之后并不会保    存User对象。
check_password(raw_password)：
如果传入的明文密码是正确的返回True。该方法和set_password是一对，也会考虑hash    转换。
set_unusable_password()：
将用户设置为没有密码的状态。调用该方法后，check_password()方法将会永远返回fal    se。但是如果，调用set_password()方法重新设置密码后，该方法将会失效，has_usabl    e_password()也会返回True。
has_usable_password()：
在调用set_unusable_password()方法之后，该方法返回False，正常情况下返回True。
get_group_permissions(obj=None)：
返回该用户通过组所拥有的许可（字符串列表每一个代表一个许可）。obj如果指定，将    会返回关于该对象的许可，而不是模型。
get_all_permissions(obj=None):
返回该用户所拥有的所有的许可，包括通过组的和通过用户赋予的许可。
has_perm(perm,obj=None)：
如果用户有传入的perm，则返回True。perm可以是一个格式为：&#39;&lt;app     label&gt;.&lt;permission codename&gt;&#39;的字符串。如果User对象为inactive，该方法永远返回    False。和前面一样，如果传入obj，则判断该用户对于这个对象是否有这个许可。
has_perms(perm_list,obj=None):
和has_perm一样，不同的地方是第一个参数是一个perm列表，只有用户拥有传入的每一    个perm，返回值才是True。
has_module_perms(package_name)：
传入的是Django app label，按照&#39;&lt;app label&gt;.&lt;permission     codename&gt;&#39;格式。当用户拥有该app     label下面所有的perm时，返回值为True。如果用户为inactive，返回值永远为False。
email_user(subject,message,from_email=None)：
发送一封邮件给这个用户，依靠的当然是该用户的email属性。如果from_email不提供的    话，Django会使用settings中的DEFAULT_FROM_EMAIL发送。
get_profile()：
返回一个和Site相关的profile对象，用来存储额外的用户信息。这个返回值会在另一片    博文中详细描述。
</code></pre>
<p>User对象的Manager，UserManager： </p>
<p>和其他的模型一样，User模型类的objects属性也是一个Manager对象，但是User的Manager对象是自定义的，增加了一些方法：</p>
<pre><code>create_user(username,email=None,password=None):该方法创建保存一个is_active=True的User对象并返回。username不能够为空，否则抛出ValueError异常。email和password都是可选的。email的domain部分会被自动转变为小写。password如果没有提供，则User对象的set_unusable_password()方法将会被调用。
make_random_password(length=10,allowed_chars=&#39;abcdefghjkmnpqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ23456789&#39;):该方法返回一个给定长度和允许字符集的密码。其中默认的allowed_chars有一些字符没有，比如i,l等等。
</code></pre>
<h2 id="Django-admin定制化，User字段扩展-转载"><a href="#Django-admin定制化，User字段扩展-转载" class="headerlink" title="Django admin定制化，User字段扩展[转载]"></a>Django admin定制化，User字段扩展[转载]</h2><p>前言</p>
<p>参考上篇博文，我们利用了OneToOneField的方式使用了django自带的user，<a href="http://www.cnblogs.com/caseast/p/5909248.html">http://www.cnblogs.com/caseast/p/5909248.html</a> ， 但这么用有个问题，就是每次增删改查数据，因为有外键的存在都要查询两次（当然可以用select_related方式减少查询次数，参考: Django models对象的select_related方法（减少查询次数） ），另外在admin中需要维护2张表，先创建User，再在UserProfile中进行关联操作。本篇就来介绍一下，如何定制User和admin达到以下目的：1.扩展django自带的User，且不通过OneToOne的方式。2.修改User中的字段，让诸如email这种字段变为必选项（默认为可选）。3.admin表单定制，让不同权限的用户显示不同的页面。<br>期间踩了很多坑，统一做一次整理，admin可定制的地方很多，但是定制的方法肯定不如自己写的后台那么灵活，需要大体了解django的User和admin的工作模式和源码，怎么取舍还看自己的需求了。</p>
<p>代码实现</p>
<p>扩展User的方法大概有4种，参考这个国外博客：<a href="https://simpleisbetterthancomplex.com/tutorial/2016/07/22/how-to-extend-django-user-model.html#proxy">https://simpleisbetterthancomplex.com/tutorial/2016/07/22/how-to-extend-django-user-model.html#proxy</a> ，我用的是里边描述的第四种方法。<br>models.py</p>
<pre><code>from django.db import models
from django.contrib.auth.models import AbstractUser, Group
# Create your models here.

&#39;&#39;&#39; OneToOne的扩展写法,原来的写法
class UserProfile(models.Model):
    user = models.OneToOneField(User)
    name = models.CharField(u&#39;姓名&#39;, max_length=32, blank=False, null=False)

    class Meta:
        verbose_name = u&#39;用户详情&#39;
        verbose_name_plural = u&quot;用户详情&quot;
&#39;&#39;&#39;

class MyUser(AbstractUser): #     继承AbstractUser类，实际上django的User也是继承他，我们要做的就是用自己的类代    替django自己的User
    name = models.CharField(u&#39;中文名&#39;, max_length=32, blank=False,     null=False)

    class Meta:
        verbose_name = u&#39;用户详情&#39;
        verbose_name_plural = u&quot;用户详情&quot;
</code></pre>
<p>这里附上Django User类部分源码</p>
<pre><code>class User(AbstractUser):
    &quot;&quot;&quot;
    Users within the Django authentication system are represented by this     model.
    Username, password and email are required. Other fields are optional.
    &quot;&quot;&quot;
    class Meta(AbstractUser.Meta):
        swappable = &#39;AUTH_USER_MODEL&#39;
</code></pre>
<p>光做以上这些还不够，我们需要告诉django，我们不用你的User了，要用自己的，所以需要在settings.py里重新设定一个变量<br>settings.py</p>
<pre><code>AUTH_USER_MODEL = &quot;web_sso.MyUser&quot;  # 我们的app叫web_sso，这个MyUser就是models定义的那个类
</code></pre>
<p>看下扩展完的效果，可以看到，我们不用再像之前一样维护“用户”和“用户详情”两张表了，但还是有很多小问题需要解决。</p>
<p>长话短说，直接看一下，我的admin.py改了哪些东西吧.<br>admin.py</p>
<pre><code>from django.contrib import admin
from web_sso import models
from django.contrib.auth.admin import UserAdmin  # 从django继承过来后进行定制
from django.utils.translation import ugettext_lazy as _
from django.contrib.auth.forms import UserCreationForm, UserChangeForm #     admin中涉及到的两个表单


class User_exAdmin(admin.ModelAdmin):  # 验证码部分展示
    list_display = (&#39;valid_code&#39;, &#39;valid_time&#39;, &#39;email&#39;)


# custom user admin
class MyUserCreationForm(UserCreationForm):  #     增加用户表单重新定义，继承自UserCreationForm
    def __init__(self, *args, **kwargs):
        super(MyUserCreationForm, self).__init__(*args, **kwargs)
        self.fields[&#39;email&#39;].required = True   #     为了让此字段在admin中为必选项，自定义一个form
        self.fields[&#39;name&#39;].required = True  #     其实这个name字段可以不用设定required，因为在models中的MyUser类中已经设定了bla    nk=False，但email字段在系统自带User的models中已经设定为
        # email = models.EmailField(_(&#39;email address&#39;),     blank=True)，除非直接改源码的django（不建议这么做），不然还是自定义一个表单做    一下继承吧。


class MyUserChangeForm(UserChangeForm):  #     编辑用户表单重新定义，继承自UserChangeForm
    def __init__(self, *args, **kwargs):
        super(MyUserChangeForm, self).__init__(*args, **kwargs)
        self.fields[&#39;email&#39;].required = True
        self.fields[&#39;name&#39;].required = True


class CustomUserAdmin(UserAdmin):
    def __init__(self, *args, **kwargs):
        super(CustomUserAdmin, self).__init__(*args, **kwargs)
        self.list_display = (&#39;username&#39;, &#39;name&#39;, &#39;email&#39;, &#39;is_active&#39;,     &#39;is_staff&#39;, &#39;is_superuser&#39;)
        self.search_fields = (&#39;username&#39;, &#39;email&#39;, &#39;name&#39;)
        self.form = MyUserChangeForm  #  编辑用户表单，使用自定义的表单
        self.add_form = MyUserCreationForm  # 添加用户表单，使用自定义的表单
        # 以上的属性都可以在django源码的UserAdmin类中找到，我们做以覆盖

    def changelist_view(self, request, extra_context=None):  #     这个方法在源码的admin/options.py文件的ModelAdmin这个类中定义，我们要重新定义    它，以达到不同权限的用户，返回的表单内容不同
        if not request.user.is_superuser:  #     非super用户不能设定编辑是否为super用户
            self.fieldsets = ((None, &#123;&#39;fields&#39;: (&#39;username&#39;, &#39;password&#39;,)&#125;),
                              (_(&#39;Personal info&#39;), &#123;&#39;fields&#39;: (&#39;name&#39;,     &#39;email&#39;)&#125;),  # _ 将(&#39;&#39;)里的内容国际化,这样可以让admin里的文字自动随着LANGUAGE    _CODE切换中英文
                              (_(&#39;Permissions&#39;), &#123;&#39;fields&#39;: (&#39;is_active&#39;,     &#39;is_staff&#39;, &#39;groups&#39;)&#125;),
                              (_(&#39;Important dates&#39;), &#123;&#39;fields&#39;:     (&#39;last_login&#39;, &#39;date_joined&#39;)&#125;),
                              )  #     这里(&#39;Permissions&#39;)中没有&#39;is_superuser&#39;,此字段定义UserChangeForm表单中的具体    显示内容，并可以分类显示
            self.add_fieldsets = ((None, &#123;&#39;classes&#39;: (&#39;wide&#39;,),
                                          &#39;fields&#39;: (&#39;username&#39;, &#39;name&#39;,     &#39;password1&#39;, &#39;password2&#39;, &#39;email&#39;, &#39;is_active&#39;,
                                                     &#39;is_staff&#39;, &#39;groups&#39;),
                                          &#125;),
                                  )      #此字段定义UserCreationForm表单中的具体显示内容
        else:  # super账户可以做任何事
            self.fieldsets = ((None, &#123;&#39;fields&#39;: (&#39;username&#39;, &#39;password&#39;,)&#125;),
                              (_(&#39;Personal info&#39;), &#123;&#39;fields&#39;: (&#39;name&#39;,     &#39;email&#39;)&#125;),
                              (_(&#39;Permissions&#39;), &#123;&#39;fields&#39;: (&#39;is_active&#39;,     &#39;is_staff&#39;, &#39;is_superuser&#39;, &#39;groups&#39;)&#125;),
                              (_(&#39;Important dates&#39;), &#123;&#39;fields&#39;:     (&#39;last_login&#39;, &#39;date_joined&#39;)&#125;),
                              )
            self.add_fieldsets = ((None, &#123;&#39;classes&#39;: (&#39;wide&#39;,),
                                          &#39;fields&#39;: (&#39;username&#39;, &#39;name&#39;,     &#39;password1&#39;, &#39;password2&#39;, &#39;email&#39;, &#39;is_active&#39;,
                                                     &#39;is_staff&#39;,     &#39;is_superuser&#39;, &#39;groups&#39;),
                                          &#125;),
                                  )
        return super(CustomUserAdmin, self).changelist_view(request,     extra_context)


admin.site.register(models.MyUser, CustomUserAdmin)  # 注册一下
admin.site.register(models.User_ex, User_exAdmin)
</code></pre>
<p>效果展示</p>
<p>首页面</p>
<p>设定组权限管理</p>
<p>编辑用户页面<br>管理员：</p>
<p>非管理员：(没有设定超级用户的权限)</p>
<p>新增用户页面</p>
<p>通过以上，基本可以实现一个用户管理后台的需求了。</p>
<p>参考资料</p>
<p><a href="https://simpleisbetterthancomplex.com/tutorial/2016/07/22/how-to-extend-django-user-model.html#proxy">https://simpleisbetterthancomplex.com/tutorial/2016/07/22/how-to-extend-django-user-model.html#proxy</a><br><a href="http://www.cnblogs.com/daliangtou/p/5435385.html">http://www.cnblogs.com/daliangtou/p/5435385.html</a><br><a href="https://docs.djangoproject.com/en/1.9/topics/auth/customizing/#django.contrib.auth.models.PermissionsMixin.has_perms">https://docs.djangoproject.com/en/1.9/topics/auth/customizing/#django.contrib.auth.models.PermissionsMixin.has_perms</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/15/python/python%E5%AE%9E%E7%8E%B0websocket,%E5%AE%9E%E6%97%B6%E6%98%BE%E7%A4%BA%E6%97%A5%E5%BF%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qiantu">
      <meta itemprop="description" content="You think you can, you can.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="向山看海">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/06/15/python/python%E5%AE%9E%E7%8E%B0websocket,%E5%AE%9E%E6%97%B6%E6%98%BE%E7%A4%BA%E6%97%A5%E5%BF%97/" class="post-title-link" itemprop="url">使用python简单的实现websocket服务器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-06-15 14:17:27" itemprop="dateCreated datePublished" datetime="2017-06-15T14:17:27+08:00">2017-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-05 10:19:43" itemprop="dateModified" datetime="2023-12-05T10:19:43+08:00">2023-12-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/websocket/" itemprop="url" rel="index"><span itemprop="name">websocket</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->



<h4 id="一、开始的话"><a href="#一、开始的话" class="headerlink" title="一、开始的话"></a>一、开始的话</h4><p>使用python简单的实现websocket服务器，可以在浏览器上实时显示远程服务器的日志信息。<br>之前做了一个web版的发布系统，但没实现在线看日志，每次发布版本后，都需要登录到服务器上查看日志，非常麻烦，为了偷懒，能在页面点几下按钮完成工作，所以这几天查找了这方面的资料，实现了这个功能，瞬间觉的看日志什么的，太方便了，以后也可以给开发们查日志，再也不用麻烦运维了，废话少说，先看效果吧。<br>[图片]</p>
<h4 id="二、代码"><a href="#二、代码" class="headerlink" title="二、代码"></a>二、代码</h4><p>在实现这功能前，看过别人的代码，发现很多都是只能在web上显示本地的日志，不能看远程主机上的日志，有些能看远程日志的是引用了其他框架（例如bottle，tornado）来实现的，而且所有这些都是重写thread的run方法来实现的，由于本人技术太菜，不知道怎么改成自己需要的样子，而且我是用django这个web框架的，不想引用太多框架，搞的太复杂，所以用python来实现websocket服务器。由于技术问题，代码有点粗糙，不过能实现功能就行，先将就着用吧。<br>执行下面命令启动django和websocketserver<br>    nohup python manage.py runserver 10.1.12.110 &amp;<br>    nohup python websocketserver.py &amp;</p>
<h4 id="启动websocket后，接收到请求，起一个线程和客户端握手，然后根据客户端发送的ip和type，去数据库查找对应的日志路径，用paramiko模块ssh登录到远程服务器上tail查看日志，再推送给浏览器，服务端完整代码如下："><a href="#启动websocket后，接收到请求，起一个线程和客户端握手，然后根据客户端发送的ip和type，去数据库查找对应的日志路径，用paramiko模块ssh登录到远程服务器上tail查看日志，再推送给浏览器，服务端完整代码如下：" class="headerlink" title="启动websocket后，接收到请求，起一个线程和客户端握手，然后根据客户端发送的ip和type，去数据库查找对应的日志路径，用paramiko模块ssh登录到远程服务器上tail查看日志，再推送给浏览器，服务端完整代码如下："></a>启动websocket后，接收到请求，起一个线程和客户端握手，然后根据客户端发送的ip和type，去数据库查找对应的日志路径，用paramiko模块ssh登录到远程服务器上tail查看日志，再推送给浏览器，服务端完整代码如下：</h4><pre><code># coding:utf-8
import struct
import base64
import hashlib
import socket
import threading
from public.public import get_ssh
import os


def recv_data(conn):    # 服务器解析浏览器发送的信息
    try:
        all_data = conn.recv(1024)
        if not len(all_data):
            return False
    except:
        pass
    else:
        code_len = ord(all_data[1]) &amp; 127
        if code_len == 126:
            masks = all_data[4:8]
            data = all_data[8:]
        elif code_len == 127:
            masks = all_data[10:14]
            data = all_data[14:]
        else:
            masks = all_data[2:6]
            data = all_data[6:]
        raw_str = &quot;&quot;
        i = 0
        for d in data:
            raw_str += chr(ord(d) ^ ord(masks[i % 4]))
            i += 1
        return raw_str


def send_data(conn, data):   # 服务器处理发送给浏览器的信息
    if data:
        data = str(data)
    else:
        return False
    token = &quot;\x81&quot;
    length = len(data)
    if length &lt; 126:
        token += struct.pack(&quot;B&quot;, length)    # struct为Python中处理二进制数的模块，二进制流为C，或网络流的形式。
    elif length &lt;= 0xFFFF:
        token += struct.pack(&quot;!BH&quot;, 126, length)
    else:
        token += struct.pack(&quot;!BQ&quot;, 127, length)
    data = &#39;%s%s&#39; % (token, data)
    conn.send(data)
    return True


def handshake(conn, address, thread_name):
    headers = &#123;&#125;
    shake = conn.recv(1024)
    if not len(shake):
        return False

    print (&#39;%s : Socket start handshaken with %s:%s&#39; % (thread_name, address[0], address[1]))
    header, data = shake.split(&#39;\r\n\r\n&#39;, 1)
    for line in header.split(&#39;\r\n&#39;)[1:]:
        key, value = line.split(&#39;: &#39;, 1)
        headers[key] = value

    if &#39;Sec-WebSocket-Key&#39; not in headers:
        print (&#39;%s : This socket is not websocket, client close.&#39; % thread_name)
        conn.close()
        return False

    MAGIC_STRING = &#39;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&#39;
    HANDSHAKE_STRING = &quot;HTTP/1.1 101 Switching Protocols\r\n&quot; \
                    &quot;Upgrade:websocket\r\n&quot; \
                    &quot;Connection: Upgrade\r\n&quot; \
                    &quot;Sec-WebSocket-Accept: &#123;1&#125;\r\n&quot; \
                    &quot;WebSocket-Origin: &#123;2&#125;\r\n&quot; \
                    &quot;WebSocket-Location: ws://&#123;3&#125;/\r\n\r\n&quot;

    sec_key = headers[&#39;Sec-WebSocket-Key&#39;]
    res_key = base64.b64encode(hashlib.sha1(sec_key + MAGIC_STRING).digest())
    str_handshake = HANDSHAKE_STRING.replace(&#39;&#123;1&#125;&#39;, res_key).replace(&#39;&#123;2&#125;&#39;, headers[&#39;Origin&#39;]).replace(&#39;&#123;3&#125;&#39;, headers[&#39;Host&#39;])
    conn.send(str_handshake)
    print (&#39;%s : Socket handshaken with %s:%s success&#39; % (thread_name, address[0], address[1]))
    print &#39;Start transmitting data...&#39;
    print &#39;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - -&#39;
    return True


def dojob(conn, address, thread_name):
    from mode import models
    handshake(conn, address, thread_name)     # 握手
    log_info = recv_data(conn)
    log_ip = log_info.split(&quot;:&quot;)[0]
    log_type = log_info.split(&quot;:&quot;)[1]

    auth_ = models.Authentication.objects.get(ip=log_ip)
    user = auth_.a_user
    pwd = auth_.a_password
    try:
        log_path = models.LogPath.objects.get(ip=log_ip, type_name__contains=log_type).log_path
    except Exception, e:
        send_data(conn, e)
        conn.close()
        print &quot;Error:&quot; + str(e)
        print (&#39;%s : Socket close with %s:%s&#39; % (thread_name, address[0], address[1]))
        return
    conn.setblocking(0)                       # 设置socket为非阻塞
    ssh = get_ssh(log_ip, user, pwd)
    ssh_t = ssh.get_transport()
    chan = ssh_t.open_session()
    chan.setblocking(0)   # 设置非阻塞
    chan.exec_command(&#39;tail -f %s&#39; % log_path)
    while True:
        clientdata = recv_data(conn)
        if clientdata is not None and &#39;quit&#39; in clientdata:
            print (&#39;%s : Socket close with %s:%s&#39; % (thread_name, address[0], address[1]))
            send_data(conn, &#39;close connect&#39;)
            conn.close()
            break
        while True:
            while chan.recv_ready():
                clientdata1 = recv_data(conn)
                if clientdata1 is not None and &#39;quit&#39; in clientdata1:
                    print (&#39;%s : Socket close with %s:%s&#39; % (thread_name, address[0], address[1]))
                    send_data(conn, &#39;close connect&#39;)
                    conn.close()
                    break
                log_msg = chan.recv(10000).strip()
                print log_msg
                send_data(conn, log_msg)
            if chan.exit_status_ready():
                break
            clientdata2 = recv_data(conn)
            if clientdata2 is not None and &#39;quit&#39; in clientdata2:
                print (&#39;%s : Socket close with %s:%s&#39; % (thread_name, address[0], address[1]))
                send_data(conn, &#39;close connect&#39;)
                conn.close()
                break
        break


def ws_service():

    os.environ.setdefault(&quot;DJANGO_SETTINGS_MODULE&quot;, &quot;lbg.settings&quot;)
    index = 1
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.bind((&quot;127.0.0.1&quot;, 12345))
    sock.listen(100)

    print (&#39;\r\n\r\nWebsocket server start, wait for connect!&#39;)
    print &#39;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - -&#39;
    while True:
        connection, address = sock.accept()
        thread_name = &#39;thread_%s&#39; % index
        print (&#39;%s : Connection from %s:%s&#39; % (thread_name, address[0], address[1]))
        t = threading.Thread(target=dojob, args=(connection, address, thread_name))
        t.start()
        index += 1


ws_service()
</code></pre>
<h4 id="get-ssh的代码如下："><a href="#get-ssh的代码如下：" class="headerlink" title="get_ssh的代码如下："></a>get_ssh的代码如下：</h4><pre><code>import paramiko
def get_ssh(ip, user, pwd):
    try:
        ssh = paramiko.SSHClient()
        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        ssh.connect(ip, 22, user, pwd, timeout=15)
        return ssh
    except Exception, e:
        print e
        return &quot;False&quot;
</code></pre>
<h4 id="打开页面时，自动连接websocket服务器，完成握手，并发送ip和type给服务端，所以可以看不同类型，不同机器上的日志，"><a href="#打开页面时，自动连接websocket服务器，完成握手，并发送ip和type给服务端，所以可以看不同类型，不同机器上的日志，" class="headerlink" title="打开页面时，自动连接websocket服务器，完成握手，并发送ip和type给服务端，所以可以看不同类型，不同机器上的日志，"></a>打开页面时，自动连接websocket服务器，完成握手，并发送ip和type给服务端，所以可以看不同类型，不同机器上的日志，</h4><p>图片</p>
<h4 id="页面代码如下"><a href="#页面代码如下" class="headerlink" title="页面代码如下:"></a>页面代码如下:</h4><pre><code>&lt;!DOCTYPE html&gt;  
&lt;html&gt;  
&lt;head&gt;
&#123;% include 'head_script.html' %&#125;
&lt;style&gt;
    #log &#123;
        width: 440px;
        height: 200px;
        border: 1px solid #7F9DB9;
        overflow: auto;
    &#125;
    pre &#123;
        margin: 0 0 0;
        padding: 0;
        border: hidden;
        background-color: #0c0c0c;
        color: #00ff00;
    &#125;
    #btns &#123;
        text-align: right;   
    &#125;
&lt;/style&gt;
    &lt;script&gt;
        var socket;
        function init() &#123;  
            var host = &quot;ws://127.0.0.1:12345/&quot;;
            var ips=&quot;&#123;&#123; ip &#125;&#125;&quot;;
            var types=&quot;&#123;&#123; type &#125;&#125;&quot;;
            var log_msg = ips +&quot;:&quot;+ types;

            console.log(log_msg);
            try &#123;
                socket = new WebSocket(host);  
                socket.onopen = function () &#123;
                    log(&#39;Connected&#39;);
                    socket.send(log_msg);
                &#125;;  
                socket.onmessage = function (msg) &#123;  
                    log(msg.data);
                    var obje = document.getElementById(&quot;log&quot;);   //日志过多时清屏
                    var textlength = obje.scrollHeight;
                    if (textlength &gt; 10000) &#123;
                        obje.innerHTML = &#39;&#39;;
                    &#125;
                &#125;;  
                socket.onclose = function () &#123;
                    log(&quot;Lose Connection!&quot;);
                    $(&quot;#start&quot;).attr(&#39;disabled&#39;, false);
                    $(&quot;#stop&quot;).attr(&#39;disabled&#39;, true);
                &#125;;
                $(&quot;#start&quot;).attr(&#39;disabled&#39;, true);
                $(&quot;#stop&quot;).attr(&#39;disabled&#39;, false);
            &#125;
            catch (ex) &#123;  
                log(ex);  
            &#125;
        &#125;
        window.onbeforeunload = function () &#123;  
            try &#123;  
                socket.send(&#39;quit&#39;);  
                socket.close();  
                socket = null;  
            &#125;  
            catch (ex) &#123;  
                log(ex);  
            &#125;  
        &#125;;
        function log(msg) &#123;
            var obje = document.getElementById(&quot;log&quot;);
            obje.innerHTML += &#39;&lt;pre&gt;&lt;code&gt;&#39; + msg + &#39;&lt;/code&gt;&lt;/pre&gt;&#39;;
            obje.scrollTop = obje.scrollHeight;   //滚动条显示最新数据
        &#125;
        function stop() &#123;
            try &#123;
                log(&#39;Close connection!&#39;);
                socket.send(&#39;quit&#39;);
                socket.close();
                socket = null;
                $(&quot;#start&quot;).attr(&#39;disabled&#39;, false);
                $(&quot;#stop&quot;).attr(&#39;disabled&#39;, true);
            &#125;
            catch (ex) &#123;
                log(ex);
            &#125;
        &#125;
        function closelayer() &#123;
            try &#123;
                log(&#39;Close connection!&#39;);
                socket.send(&#39;quit&#39;);
                socket.close();
                socket = null;
            &#125;
            catch (ex) &#123;
                log(ex);
            &#125;
            var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
            parent.layer.close(index); //再执行关闭
        &#125;
    &lt;/script&gt;
&lt;/head&gt;  

&lt;body onload=&quot;init()&quot;&gt;  
    &lt;div class=&quot;row&quot;&gt;
        &lt;div class=&quot;col-lg-12&quot;&gt;
            &lt;div id=&quot;log&quot; style=&quot;width: 100%;height:440px;background-color: #0c0c0c;overflow:scroll;overflow-x: auto;&quot;&gt;&lt;/div&gt;
            &lt;br&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;row&quot;&gt;
        &lt;div class=&quot;col-lg-12&quot;&gt;
            &lt;div id=&quot;btns&quot;&gt;
                &lt;input disabled=&quot;disabled&quot; type=&quot;button&quot; class=&quot;btn btn-primary btn-sm&quot; value=&quot;start&quot; id=&quot;start&quot; onclick=&quot;init()&quot;&gt;
                &lt;input disabled=&quot;disabled&quot; type=&quot;button&quot; class=&quot;btn btn-primary btn-sm&quot; value=&quot;stop&quot; id=&quot;stop&quot; onclick=&quot;stop()&quot; &gt;
                &lt;input type=&quot;button&quot; class=&quot;btn btn-primary btn-sm&quot; value=&quot;close&quot; id=&quot;close&quot; onclick=&quot;closelayer()&quot; &gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;  
&#123;% include 'foot_script.html' %&#125;
&lt;/html&gt; 
</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/15/python/Python-Jenkins%20API%E4%BD%BF%E7%94%A8%20%E2%80%94%E2%80%94%20%E5%9C%A8%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81%E4%B8%AD%E6%93%8D%E6%8E%A7Jenkins/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qiantu">
      <meta itemprop="description" content="You think you can, you can.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="向山看海">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/06/15/python/Python-Jenkins%20API%E4%BD%BF%E7%94%A8%20%E2%80%94%E2%80%94%20%E5%9C%A8%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81%E4%B8%AD%E6%93%8D%E6%8E%A7Jenkins/" class="post-title-link" itemprop="url">Python-Jenkins API使用 —— 在后端代码中操控Jenkins</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-06-15 14:17:27" itemprop="dateCreated datePublished" datetime="2017-06-15T14:17:27+08:00">2017-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-05 10:19:43" itemprop="dateModified" datetime="2023-12-05T10:19:43+08:00">2023-12-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jenkins/" itemprop="url" rel="index"><span itemprop="name">jenkins</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->





<h4 id="Python-Jenkins-API使用-——-在后端代码中操控Jenkins"><a href="#Python-Jenkins-API使用-——-在后端代码中操控Jenkins" class="headerlink" title="Python-Jenkins API使用 —— 在后端代码中操控Jenkins"></a>Python-Jenkins API使用 —— 在后端代码中操控Jenkins</h4><p>最近在工作中需要用到在后台代码中触发Jenkins任务的构建，于是想到Jenkins是否有一些已经封装好的API类库提供，用于处理跟Jenkins相关的操作。下面就简单介绍下我的发现。</p>
<h4 id="Linux-Curl"><a href="#Linux-Curl" class="headerlink" title="Linux Curl"></a>Linux Curl</h4><p>首先找到的是Jenkins官网的wiki：<a href="https://wiki.jenkins-ci.org/display/JENKINS/Remote+access+API">https://wiki.jenkins-ci.org/display/JENKINS/Remote+access+API</a></p>
<p>在官网首页就有关于触发job的方法：</p>
<p>个人尝试了下，该方式是通过命令行直接调curl去发POST请求的方式来触发job的构建。对于用openid管理的Jenkins，需要带上参数–user USER:PASSWORD，其中的USER和PASSWORD不是你的openID登录的账号密码，而是登录后显示在Jenkins中的User Id和API Token，它们的的查看方式如下：</p>
<p>用openID登录jenkins —&gt; 点击右上角的用户名，进入用户个人页面 —&gt;  点击左边的设置，打开设置页面 —&gt; API Token，Show Api Token…</p>
<p>如果需要参数化构建job，则要加上–data-urlencode json&#x3D;’{“parameter”: [{“name”:”param_name1”,”value”:”param_value1”}, {“name”:”param_name2”,”value”:”param_value2”}]}’</p>
<p>显然，这种方式比较繁琐，很容易出现因格式不正确导致触发任务失败，而且这种方式不能帮助我们获取更多的关于job的信息以便于我们后续对job的状态进行跟踪。</p>
<h4 id="Python-Jenkins"><a href="#Python-Jenkins" class="headerlink" title="Python-Jenkins"></a>Python-Jenkins</h4><p>继续寻找，然后我在Jenkins官网上找到了Python-Jenkins API，仔细阅读后发现，它几乎涵盖了大部分Jenkins的操作，大大方便了我们在后台进行对Jenkins的一些列操作。</p>
<p>Python-Jenkins官网：<a href="https://pypi.python.org/pypi/python-jenkins/">https://pypi.python.org/pypi/python-jenkins/</a></p>
<p>Python-Jenkins Doc：<a href="http://python-jenkins.readthedocs.io/en/latest/index.html">http://python-jenkins.readthedocs.io/en/latest/index.html</a></p>
<p>下面简单介绍下如何使用Python-Jenkins：</p>
<h4 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h4><pre><code>sudo pip install python-jenkins
</code></pre>
<h4 id="2-进入python命令环境或创建新的-py文件jenkinsApiTest-py"><a href="#2-进入python命令环境或创建新的-py文件jenkinsApiTest-py" class="headerlink" title="2. 进入python命令环境或创建新的.py文件jenkinsApiTest.py"></a>2. 进入python命令环境或创建新的.py文件jenkinsApiTest.py</h4><pre><code>import jenkins
#定义远程的jenkins master server的url，以及port
jenkins_server_url=&#39;xxxx:xxxx&#39;
#定义用户的User Id 和 API Token，获取方式同上文
user_id=&#39;xxxx&#39;
api_token=&#39;xxxx&#39;
#实例化jenkins对象，连接远程的jenkins master server
server=jenkins.Jenkins(jenkins_server_url, username=user_id, password=api_token)
#构建job名为job_name的job（不带构建参数）
server.build_job(job_name)
#String参数化构建job名为job_name的job, 参数param_dict为字典形式，如：param_dict= &#123;&quot;param1&quot;：“value1”， “param2”：“value2”&#125;
server.build_job(job_name, parameters=param_dict)
#获取job名为job_name的job的相关信息
server.get_job_info(job_name)
#获取job名为job_name的job的最后次构建号
server.get_job_info(job_name)[&#39;lastBuild&#39;][&#39;number&#39;]
#获取job名为job_name的job的某次构建的执行结果状态
server.get_build_info(job_name,build_number)[&#39;result&#39;]　　
#判断job名为job_name的job的某次构建是否还在构建中
server.get_build_info(job_name,build_number)[&#39;building&#39;]
</code></pre>
<p>　　3. 更多其他的API可以参考Python-Jenkins API：<a href="http://python-jenkins.readthedocs.io/en/latest/api.html">http://python-jenkins.readthedocs.io/en/latest/api.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/15/zjump/zjump/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qiantu">
      <meta itemprop="description" content="You think you can, you can.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="向山看海">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/06/15/zjump/zjump/" class="post-title-link" itemprop="url">zjump</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-06-15 14:17:27" itemprop="dateCreated datePublished" datetime="2017-06-15T14:17:27+08:00">2017-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-05 10:19:43" itemprop="dateModified" datetime="2023-12-05T10:19:43+08:00">2023-12-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/sql%E5%AE%A1%E6%A0%B8/" itemprop="url" rel="index"><span itemprop="name">sql审核</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- toc -->



<h2 id="项目开发背景"><a href="#项目开发背景" class="headerlink" title="项目开发背景"></a>项目开发背景</h2><pre><code>由于最近线上补单，数据修改，等人工操作频繁。每次都要发邮件手动执行，很容易导致出错，  
没有很好的历史纪录。而且浪费时间。虽然后台系统在不停完善，但是那些功能都是死的，无法针对所有sql。  
所以本人就写了dbtool这个web数据库管理后台。  
</code></pre>
<h2 id="项目开发目标"><a href="#项目开发目标" class="headerlink" title="项目开发目标"></a>项目开发目标</h2><pre><code>web端数据查询
web端sql检测，保证每次线上执行的sql准确性，时实性
每次检测sql将在从库执行，但不commit，返回sql将会影响的行数，sql执行状态等。然后rollback。
开发提交sql，主管审核，最后运维确认执行或者作废。所有sql提交，审核，执行。等状态记录。（后续添加更详细的流程，比如修改数据超过1000行需要总监审核等）
Sql执行时间记录
统计哪些表修改最频繁，说明涉及该表的需要优化（后续计划）
Sql语法高亮(后续计划)
</code></pre>
<h2 id="项目的开发方法"><a href="#项目的开发方法" class="headerlink" title="项目的开发方法"></a>项目的开发方法</h2><pre><code>本系统采用在jumpserver开源堡垒机上面二次开发。省去大量开发时间。  
登陆，权限验证等都采用jumpserver的。快速实现公司需要的功能  
</code></pre>
<h2 id="项目用到的知识"><a href="#项目用到的知识" class="headerlink" title="项目用到的知识"></a>项目用到的知识</h2><pre><code>Python,django, tornado,javascript, jquery,easyui等  
</code></pre>
<h2 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h2><pre><code>Git 地址  https://github.com/xskh2007/zjump 
QQ群：391096485
</code></pre>
<h2 id="项目心得"><a href="#项目心得" class="headerlink" title="项目心得"></a>项目心得</h2><pre><code>这是我第一次做项目，也是第一次二次开发开源项目，在这之前我甚至不会jq，不会js,但是看看网上demo,依葫芦画瓢也算实现基本功能了。
我觉的看别人的代码对提高自己有很大帮助。有一次跟一同事聊高中学习的事，他说他以前都不会写作文，至从跟语文课代表坐一起，
看了他的作文后，忽然恍然大悟，原来作文可以这么写。其实都是套路，写代码也差不多。jumpserver的注释并不是很多，但命名还是能看出大概作用。
</code></pre>
<h2 id="项目功能附图"><a href="#项目功能附图" class="headerlink" title="项目功能附图"></a>项目功能附图</h2><h4 id="线上sql查询界面"><a href="#线上sql查询界面" class="headerlink" title="线上sql查询界面"></a>线上sql查询界面</h4><p><img src="https://raw.githubusercontent.com/xskh2007/xskh2007.github.io/master/images/zjump/select.jpg" alt="Screenshot"> </p>
<h4 id="线上sql检测界面"><a href="#线上sql检测界面" class="headerlink" title="线上sql检测界面"></a>线上sql检测界面</h4><p><img src="https://raw.githubusercontent.com/xskh2007/xskh2007.github.io/master/images/zjump/check.png" alt="Screenshot"> </p>
<h4 id="线上sql提交界面"><a href="#线上sql提交界面" class="headerlink" title="线上sql提交界面"></a>线上sql提交界面</h4><p><img src="https://raw.githubusercontent.com/xskh2007/xskh2007.github.io/master/images/zjump/submit.png" alt="Screenshot"> </p>
<h4 id="线上sql操作界面，可以执行，和作废"><a href="#线上sql操作界面，可以执行，和作废" class="headerlink" title="线上sql操作界面，可以执行，和作废"></a>线上sql操作界面，可以执行，和作废</h4><p><img src="https://raw.githubusercontent.com/xskh2007/xskh2007.github.io/master/images/zjump/deail_list.png" alt="Screenshot"> </p>
<h4 id="具体sql查看界面"><a href="#具体sql查看界面" class="headerlink" title="具体sql查看界面"></a>具体sql查看界面</h4><p><img src="https://raw.githubusercontent.com/xskh2007/xskh2007.github.io/master/images/zjump/deail.png" alt="Screenshot"> </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">qiantu</p>
  <div class="site-description" itemprop="description">You think you can, you can.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">30</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">qiantu</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
